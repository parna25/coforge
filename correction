using RabbitMQ.Client;
using RabbitMQ.Client.Events;
using System.Text;
using System.Threading.Tasks;

public class RabbitMqConsumer
{
    private readonly ConnectionFactory _factory;

    public RabbitMqConsumer()
    {
        _factory = new ConnectionFactory()
        {
            Uri = new Uri("amqps://<your-cloudamqp-url>")
        };
    }

    public async Task<string> ReceiveMail()
    {
        // Create async connection & channel
        await using var connection = await _factory.CreateConnectionAsync();
        await using var channel = await connection.CreateChannelAsync();

        // Declare queue asynchronously
        await channel.QueueDeclareAsync(
            queue: "mail_queue",
            durable: true,
            exclusive: false,
            autoDelete: false
        );

        // Get message using async
        var result = await channel.BasicGetAsync("mail_queue", autoAck: true);

        if (result == null)
        {
            return "No mail available in queue.";
        }

        var message = Encoding.UTF8.GetString(result.Body.ToArray());
        return message;
    }
}
